---
- name: run tasks for el-based hosts
  include_tasks:
    file: el.yml
  when: os_name == 'CentOS' or os_name == 'RedHat'

- name: run tasks for debian-based hosts
  include_tasks:
    file: deb.yml
  when: os_name == 'Ubuntu' or os_name == 'Debian'

- name: mount nfs shares
  mount:
    fstype: nfs
    opts: defaults
    dump: '0'
    passno: '0'
    state: mounted
    src: fs01:/srv/shared
    path: /nfs/fs01/shared

- name: Install pexpect using pip
  pip:
    name: pexpect

- name: check domain join status
  command: /bin/sh -c "/usr/sbin/realm list"
  register: realm_status

- name: join system to AD
  expect:
    command: /bin/sh -c "/usr/sbin/realm join --user={{ ad_join_account }} --computer-ou=OU=Linux,OU=Servers,DC={{ domain_name_start }},DC={{ domain_suffix_only }} {{ domain_name }}"
    responses:
      Password for *: "{{ bind_password }}"
  when: realm_status.stdout == ""

- name: Check if machine is bound
  shell: /bin/sh -c "realm list | grep sssd"
  register: realmd_bound
  changed_when: true
  ignore_errors: true

- name: allow admin ad group logon privileges
  command: /bin/sh -c "/usr/sbin/realm permit -g {{ ad_admin_group }}"
  when: realmd_bound is not failed
  
- name: add admin ad group to sudoers
  lineinfile:
    dest: /etc/sudoers
    insertafter: '^%wheel'
    line: '%{{ ad_admin_group }}        ALL=(ALL)       NOPASSWD: ALL'

- name: add admin ad group to sshd_config
  command: "echo \"AllowGroups {{ ad_admin_group }}\" >> /etc/ssh/sshd_config"

- name: set up krb5
  template:
    src: krb5.conf.j2
    dest: /etc/krb5.conf
    backup: yes

- name: set up sssd
  template:
    src: sssd.conf.j2
    dest: /etc/sssd/sssd.conf
    backup: yes

- name: restart sssd
  systemd:
    name: sssd
    state: restarted